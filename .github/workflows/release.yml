name: Release & Publish

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  create-release:
    runs-on: ubuntu-latest

    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ env.VERSION }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æå–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            CHANGELOG=$(cat CHANGELOG.md | head -50)
          else
            CHANGELOG=$(git log --oneline -10)
          fi
          echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release v${{ env.VERSION }}
          body: |
            # INAV Node Server v${{ env.VERSION }}

            ## æ–°å¢åŠŸèƒ½
            - Decompile åŠŸèƒ½å·²ä¿®å¤å’Œä¼˜åŒ–
            - å¤šæ ¼å¼æ‰“åŒ…æ”¯æŒ (ZIPã€NPMã€Docker)
            - å®Œæ•´çš„ REST API
            - Docker Compose ä¸€é”®å¯åŠ¨

            ## ä½¿ç”¨æŒ‡å—

            ### å¿«é€Ÿå¼€å§‹
            ```bash
            docker-compose up -d
            ```

            ### æŸ¥çœ‹ API æ–‡æ¡£
            ```
            http://localhost:3000/docs
            ```

            ### éªŒè¯å¥åº·çŠ¶æ€
            ```bash
            curl http://localhost:3000/health
            ```

            ## æ–‡æ¡£
            - [å¿«é€Ÿå¼€å§‹](https://github.com/mediumui/inav_node_server/blob/main/START_HERE.md)
            - [éƒ¨ç½²æŒ‡å—](https://github.com/mediumui/inav_node_server/blob/main/DEPLOYMENT_COMPLETE.md)
            - [API æ–‡æ¡£](https://github.com/mediumui/inav_node_server/blob/main/USAGE.md)
            - [æ‰“åŒ…æŒ‡å—](https://github.com/mediumui/inav_node_server/blob/main/PACKAGING.md)

            ## ä¸‹è½½
            - [ZIP åŒ…](#)
            - [Docker Hub](https://hub.docker.com/r/mediumui/inav-node-server)
            - [NPM åŒ…](https://www.npmjs.com/package/inav-node-server)
          draft: false
          prerelease: false

  build-artifacts:
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: å®‰è£…ä¾èµ–
        run: npm install

      - name: æ„å»ºæ‰“åŒ…
        run: |
          chmod +x build.sh
          ./build.sh clean zip npm

      - name: ä¸Šä¼  ZIP åŒ…
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./dist/inav-node-server-*.zip
          asset_name: inav-node-server-${{ needs.create-release.outputs.version }}.zip
          asset_content_type: application/zip

      - name: ä¸Šä¼  NPM åŒ…
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./dist/inav-node-server-*.tgz
          asset_name: inav-node-server-${{ needs.create-release.outputs.version }}.tgz
          asset_content_type: application/gzip

  publish-npm:
    runs-on: ubuntu-latest
    if: ${{ secrets.NPM_TOKEN != '' }}

    steps:
      - uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          registry-url: "https://registry.npmjs.org"

      - name: å®‰è£…ä¾èµ–
        run: npm install

      - name: å‘å¸ƒåˆ° NPM
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-docker:
    runs-on: ubuntu-latest
    if: ${{ secrets.DOCKER_USERNAME != '' }}

    steps:
      - uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/inav-node-server:latest
            ${{ secrets.DOCKER_USERNAME }}/inav-node-server:${{ github.ref_name }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/inav-node-server:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/inav-node-server:buildcache,mode=max

  github-pages:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: ç”Ÿæˆ GitHub Pages æ–‡æ¡£
        run: |
          mkdir -p docs
          cp START_HERE.md docs/index.md
          cp USAGE.md docs/api.md
          cp DEPLOYMENT_COMPLETE.md docs/deployment.md
          cp PACKAGING.md docs/packaging.md
          echo "---" > docs/_config.yml
          echo "title: INAV Node Server" >> docs/_config.yml
          echo "theme: jekyll-theme-cayman" >> docs/_config.yml

      - name: ä¸Šä¼  GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./docs"

  deploy-pages:
    runs-on: ubuntu-latest
    needs: github-pages
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify:
    runs-on: ubuntu-latest
    needs: [create-release, build-artifacts, publish-docker]
    if: always()

    steps:
      - name: å‘å¸ƒå®Œæˆé€šçŸ¥
        run: |
          echo "## å‘å¸ƒå®Œæˆ"
          echo ""
          echo "âœ… ç‰ˆæœ¬: ${{ github.ref_name }}"
          echo "âœ… Docker é•œåƒå·²æ¨é€"
          echo "âœ… NPM åŒ…å·²å‘å¸ƒ"
          echo "âœ… GitHub é¡µé¢å·²æ›´æ–°"
          echo ""
          echo "ä¸‹è½½åœ°å€:"
          echo "- ğŸ³ Docker: docker pull ${{ secrets.DOCKER_USERNAME }}/inav-node-server:latest"
          echo "- ğŸ“¦ NPM: npm install inav-node-server"
          echo "- ğŸ“¥ GitHub: https://github.com/mediumui/inav_node_server/releases/tag/${{ github.ref_name }}"
