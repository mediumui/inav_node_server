name: Deploy to Production

on:
  push:
    branches: [main]
    paths:
      - "server.js"
      - "routes/**"
      - "js/**"
      - "Dockerfile"
      - "docker-compose.yml"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-docker-compose:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: 验证 Docker Compose 配置
        run: docker-compose config

      - name: 构建 Docker 镜像
        run: docker-compose build

      - name: 运行容器测试
        run: |
          docker-compose up -d
          sleep 5
          curl http://localhost:3000/health || echo "Health check failed"
          docker-compose down

  deploy-heroku:
    runs-on: ubuntu-latest
    if: secrets.HEROKU_API_KEY != '' && github.event.inputs.environment != 'staging'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 部署到 Heroku
        uses: akhileshns/heroku-deploy@v3.13.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: "inav-node-server"
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          branch: "main"
          appdir: "."
        continue-on-error: true

  deploy-railway:
    runs-on: ubuntu-latest
    if: secrets.RAILWAY_TOKEN != '' && github.event.inputs.environment != 'staging'

    steps:
      - uses: actions/checkout@v4

      - name: 部署到 Railway
        uses: 0x4non/railway-deploy-action@v1
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: inav-node-server
        continue-on-error: true

  notify:
    runs-on: ubuntu-latest
    needs: [deploy-docker-compose]
    if: always()

    steps:
      - name: 部署状态通知
        run: |
          if [ "${{ needs.deploy-docker-compose.result }}" == "success" ]; then
            echo "✅ 部署成功!"
            echo "服务地址: http://localhost:3000"
            echo "API 文档: http://localhost:3000/docs"
          else
            echo "❌ 部署失败，请检查日志"
          fi
